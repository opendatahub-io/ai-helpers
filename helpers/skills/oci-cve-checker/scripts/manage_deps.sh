#!/bin/bash
# Dependency management for OCI CVE Checker
# Can be run standalone or sourced by other scripts

set -euo pipefail

# Tool versions (for dependency tracking and updates via Renovate)
# renovate: datasource=github-releases depName=aquasecurity/trivy
TRIVY_VERSION="${TRIVY_VERSION:-0.68.2}"
# renovate: datasource=github-releases depName=jqlang/jq
JQ_VERSION="${JQ_VERSION:-1.7.1}"
# renovate: datasource=github-releases depName=containers/skopeo
SKOPEO_VERSION="${SKOPEO_VERSION:-1.14.0}"

# Detect platform (OS and architecture)
detect_platform() {
    local os arch

    # Detect OS
    os=$(uname -s)
    case "$os" in
        Linux*)  OS_TYPE="linux" ;;
        Darwin*) OS_TYPE="darwin" ;;
        *)
            echo "Error: Unsupported OS: $os" >&2
            return 1
            ;;
    esac

    # Detect architecture
    arch=$(uname -m)
    case "$arch" in
        x86_64|amd64)  ARCH_TYPE="amd64" ;;
        aarch64|arm64) ARCH_TYPE="arm64" ;;
        *)
            echo "Error: Unsupported architecture: $arch" >&2
            return 1
            ;;
    esac

    # Map to tool-specific naming conventions
    # Trivy uses different naming
    case "$OS_TYPE-$ARCH_TYPE" in
        linux-amd64)  TRIVY_PLATFORM="Linux-64bit" ;;
        linux-arm64)  TRIVY_PLATFORM="Linux-ARM64" ;;
        darwin-amd64) TRIVY_PLATFORM="macOS-64bit" ;;
        darwin-arm64) TRIVY_PLATFORM="macOS-ARM64" ;;
    esac

    # jq and skopeo use consistent naming: {os}-{arch}
    JQ_PLATFORM="${OS_TYPE}-${ARCH_TYPE}"
    SKOPEO_PLATFORM="${OS_TYPE}-${ARCH_TYPE}"

    # For macOS, use "macos" for jq
    if [ "$OS_TYPE" = "darwin" ]; then
        JQ_PLATFORM="macos-${ARCH_TYPE}"
    fi

    return 0
}

# Initialize platform detection
detect_platform || exit 1

# Auto-install missing dependencies to a temporary location
auto_install_deps() {
    local install_dir="${TMPDIR:-/tmp}/oci-cve-checker-tools"
    mkdir -p "$install_dir"

    if ! command -v trivy &> /dev/null; then
        echo "Installing trivy ${TRIVY_VERSION} for ${TRIVY_PLATFORM} to ${install_dir}..." >&2
        curl -sfL "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_${TRIVY_PLATFORM}.tar.gz" | \
            tar -xz -C "$install_dir" trivy 2>/dev/null || {
            echo "Error: Failed to install trivy ${TRIVY_VERSION} for ${TRIVY_PLATFORM}" >&2
            return 1
        }
        export PATH="${install_dir}:${PATH}"
    fi

    if ! command -v jq &> /dev/null; then
        echo "Installing jq ${JQ_VERSION} for ${JQ_PLATFORM} to ${install_dir}..." >&2
        curl -sfL -o "${install_dir}/jq" "https://github.com/jqlang/jq/releases/download/jq-${JQ_VERSION}/jq-${JQ_PLATFORM}" || {
            echo "Error: Failed to install jq ${JQ_VERSION} for ${JQ_PLATFORM}" >&2
            return 1
        }
        chmod +x "${install_dir}/jq"
        export PATH="${install_dir}:${PATH}"
    fi

    if ! command -v skopeo &> /dev/null; then
        echo "Installing skopeo ${SKOPEO_VERSION} for ${SKOPEO_PLATFORM} to ${install_dir}..." >&2
        curl -sfL -o "${install_dir}/skopeo" "https://github.com/containers/skopeo/releases/download/v${SKOPEO_VERSION}/skopeo-${SKOPEO_PLATFORM}" || {
            echo "Error: Failed to install skopeo ${SKOPEO_VERSION} for ${SKOPEO_PLATFORM}" >&2
            return 1
        }
        chmod +x "${install_dir}/skopeo"
        export PATH="${install_dir}:${PATH}"
    fi

    return 0
}

# Check dependencies
check_dependencies() {
    local missing_deps=()

    if ! command -v trivy &> /dev/null; then
        missing_deps+=("trivy")
    fi

    if ! command -v jq &> /dev/null; then
        missing_deps+=("jq")
    fi

    if ! command -v skopeo &> /dev/null; then
        missing_deps+=("skopeo")
    fi

    if [ ${#missing_deps[@]} -gt 0 ]; then
        echo "Missing dependencies: ${missing_deps[*]}" >&2
        echo "Attempting auto-install of required tools..." >&2
        if ! auto_install_deps; then
            echo "" >&2
            echo "Auto-install failed. Manual installation required for ${OS_TYPE}-${ARCH_TYPE}:" >&2
            echo "  trivy ${TRIVY_VERSION}: curl -sfL https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_${TRIVY_PLATFORM}.tar.gz | tar -xz trivy" >&2
            echo "  jq ${JQ_VERSION}: curl -sfL -o jq https://github.com/jqlang/jq/releases/download/jq-${JQ_VERSION}/jq-${JQ_PLATFORM} && chmod +x jq" >&2
            echo "  skopeo ${SKOPEO_VERSION}: curl -sfL -o skopeo https://github.com/containers/skopeo/releases/download/v${SKOPEO_VERSION}/skopeo-${SKOPEO_PLATFORM} && chmod +x skopeo" >&2
            return 1
        fi
        echo "Auto-install completed successfully" >&2
    fi
    return 0
}

# Print version information
print_version_info() {
    echo "Tool versions:"
    if command -v trivy &> /dev/null; then
        echo "  trivy: $(trivy --version 2>/dev/null | head -1 || echo 'unknown') (expected: ${TRIVY_VERSION})"
    fi
    if command -v jq &> /dev/null; then
        echo "  jq: $(jq --version 2>/dev/null || echo 'unknown') (expected: ${JQ_VERSION})"
    fi
    if command -v skopeo &> /dev/null; then
        echo "  skopeo: $(skopeo --version 2>/dev/null | head -1 || echo 'unknown') (expected: ${SKOPEO_VERSION})"
    fi
    echo ""
}

# If run directly (not sourced), check and install dependencies
if [ "${BASH_SOURCE[0]}" -ef "$0" ]; then
    echo "=== OCI CVE Checker Dependency Installer ==="
    echo ""
    if check_dependencies; then
        echo ""
        print_version_info
        echo "All dependencies are installed and ready!"
    else
        exit 1
    fi
fi
